# Example: Using yProv4SQA with the iTwinAI Repository

In this example, we demonstrate how to use our library by analyzing the the [iTwinAI GitHub repository](https://github.com/interTwin-eu/itwinai).  

This repository already utilizes SQAaaS and contains existing assessments. We will use it to Showcase the capabilities of our library and Extract insights related to software quality and provenance.

## GitHub API rate-limit notice
To avoid delays we **strongly recommend** that you authenticate.
*Export it in your shell (temporary)*
   ```bash
   export GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxx #<replace with your GITHUB_TOKEN>
   ```
Verify quota
   ```bash
   curl -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/rate_limit
   ```
You should see "limit": 5000

## **Clone the repository and navigate to the directory:**
   ```bash
   git clone https://github.com/username/yProv4SQA.git
   cd yProv4SQA
   ```
   
## **Setup the environment and install dependencies:**

### 1. Create and activate a virtual environment (recommended)

   ```bash
   # Create a virtual environment
   python -m venv yProv4SQA_venv

   # Activate the virtual environment
   source yProv4SQA_venv/bin/activate

   ```
This ensures that all dependencies are installed in an isolated environment, preventing conflicts with other Python packages on your system.

### **2. Install the library and required dependencies:**
   ```bash
   pip install -e .
   pip install requests
   ```
This installs the library and also installs the requests library, which is required to run the examples.

## **Fetch SQA reports:**
   ```bash
   fetch-sqa-reports itwinai
   ```
This command fetches all SQAaaS assessments for the `itwinai` repository from the [EOSC-Synergy GitHub space](https://github.com/EOSC-synergy). The library then downloads all available reports, removes duplicates and outdated versions, and produces a final cleaned folder used to generate the provenance document. For this example, the output folder will be created as `./itwinai_SQAaaS_reports`.


## **Generate provenance documents:**
   ```bash
   process-provenance ./itwinai_SQAaaS_reports
   ```
This command generates a provenance document of all assesment avaliable in itwinai_SQAaaS_reports folder using W3C PROV-DM standard.
It will produce a .json file named `interTwin-eu_itwinai_prov_output.json` in Provenance_documents folder, which can be further used for exploration and analysis.

## **Compare two assessments:**
   ```bash
   compare ./Provenance_documents/interTwin-eu_itwinai_prov_output.json 59 87
   ```
This file `./Compare_commit_provenance/itwinai_commit_provenance_040b...ea8b_to_96fd...56c0.json`


## **Exploration of Provenance graph**
We can use several tools to visualize and analyze the generated provenance document.
### 1. Using the PROV Library
This PROV library can be used to check the PROV syntax, convert the provenance document into an SVG graph for standard visualization, and ensure compliance with the W3C PROV standard.

**Command:**
   ```bash
   json2graph.py prov_output.json
   ```
This will generate an .SVG graph representing the provenance. Graph_outputs
Fig. 4 in the paper shows an example of the visualization generated by this command. The result of this command can be found in the folder: ./Graph_outputs/.

### 2. Using yProv4Explorer

The **yProv4Explorer** allows interactive exploration of the provenance document.  

You can either:

- Upload the `prov_output.json` file into the explorer, or  
- Drag and drop the file for better visualization.  

Access the explorer here: [https://explorer.yprov.disi.unitn.it/](https://explorer.yprov.disi.unitn.it/)

For convenience, we have already uploaded the graphs to the yProv server. You can directly open them without uploading the `.json` file:

- **Full assessment history (Fig. 5):** [View Graph](https://explorer.yprov.disi.unitn.it/?file=http%3A%2F%2Fyprov.disi.unitn.it%3A3000%2Fapi%2Fv0%2Fdocuments%2Fitwinai)  
- **Bronze-vs-Silver diff (Fig. 7):** [View Graph](https://explorer.yprov.disi.unitn.it/?file=http%3A%2F%2Fyprov.disi.unitn.it%3A3000%2Fapi%2Fv0%2Fdocuments%2Fgitdif)


### Usingy yProv and Neo4j for Provenance Visualization and Data Exploration
The yProv service provides functionality for storing and managing W3C PROV-compliant provenance documents. After registering with the service, provenance documents can be uploaded and automatically synchronized with a Neo4j graph database for interactive exploration.

To set up the environment (yProv service + Neo4j database), please follow the instructions in: [Running yProv service](./Pre_requisites/yProv/README.md)

Once both containers are running, you can interact with the yProv REST API as shown below.
   
Register to the yProv service
   ```bash
   curl -X POST http://localhost:3000/api/v0/auth/register -H 'Content-Type: application/json' -d '{"user": "...", "password": "..."}'
   ```
Log in to the service to get a valid token for performing all the other operations
   ```bash
   curl -X POST http://localhost:3000/api/v0/auth/login -H 'Content-Type: application/json' -d '{"user": "...", "password": "..."}'
   ```
Load the JSON document associated to the PTA use case
   ```bash
   curl -X PUT  http://localhost:3000/api/v0/documents/itwinai -H "Content-Type: application/json" -H 'Authorization: Bearer <token>' -d @./Provenance_documents/interTwin-eu_itwinai_prov_output.json
   ```

After uploading the provenance document, open Neo4j in your browser using the mapped ports, typically:
http://localhost:7474/browser/
Neo4j can now be used to run Cypher queries to inspect the provenance graph and explore relationships related to software quality assessments.

Cypher Query (Listing 1)
The following query retrieves commit metadata, quality criteria, and percentage values for each assessment:

   ```bash
   MATCH (e:Entity)-[:wasGeneratedBy]->(a:Activity)
   WHERE a.`ex:percentage` IS NOT NULL
   RETURN
      e.`ex:commit_id` AS CommitID,
      e.`ex:commit_date` AS CommitDate,
      a.`ex:description` AS QualityCriteria,
      a.`ex:percentage` AS PercentagePassed
   ORDER BY e.`ex:commit_date`
   ```
The output of this query is available at [Results of Listing1](./Results/Queryresults/Listing1) 

After exporting the query result from Neo4j, the data can be imported into Excel and visualized using a line chart, similar to the chart presented in Figure 6 of the paper.
The generated chart and dataset are also available at:[Results of Listing1](./Results/Queryresults/Listing1) 

Cypher Query (Listing 2)

The following query retrieves commit metadata, quality criteria, and percentage values for each assessment:
   ```bash
   // Earliest Bronze badge
   MATCH (bronze:Entity)-[:wasDerivedFrom]->(bronze_ass:Entity)
   WHERE bronze.`ex:badge_won` = "bronze"
   WITH bronze , bronze_ass
   ORDER BY bronze_ass.`ex:commit_date` ASC
   LIMIT 1
   // Earliest Silver badge
   MATCH (silver:Entity)-[:wasDerivedFrom]->(silver_ass:Entity)
   WHERE silver.`ex:badge_won` = "silver"
   WITH bronze , bronze_ass, silver , silver_ass
   ORDER BY silver_ass.`ex:commit_date` ASC
   LIMIT 1
   RETURN 
   bronze_ass.`ex:commit_id` AS BronzeCommitID,
   bronze_ass.`ex:commit_date` AS BronzeCommitDate,
   bronze.`ex:badge_won` AS BronzeBadge,
   bronze_ass.id,
   silver_ass.`ex:commit_id` AS SilverCommitID,
   silver_ass.`ex:commit_date` AS SilverCommitDate,
   silver.`ex:badge_won` AS SilverBadge,
   silver_ass.id
   ```







### 3. Using Neo4j Database visualization
We use the **yProv service** to connect with a Neo4j database for exploring the provenance data.  
This allows writing **Cypher queries** to analyze the provenance graph and retrieve specific results.
Here are some sample queries that can be run on the Neo4j database to perform analyses and extract results:
   ```cypher
   // Example 1: Retrieve all nodes and relationships
   MATCH (n)-[r]->(m) 
   RETURN n, r, m;
   ```

